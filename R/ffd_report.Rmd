---
title: "FFD report"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	results = "hide"
)

library("here")
library("dplyr")
library("ggplot2")
library("purrr")
library("tidyr")
library("patchwork")
library("stringr")
library("readr")
library("lubridate")
library("scales")

source(here("R", "money.R"))


# Read in datasets
ffd <- read.csv(here("data", "raw", "ffd202103.csv"),
                col.names = c("year", "month", "flow", "divcode", "divdesc", "product", "value", "tonnes")) %>% 
  mutate(date = as.Date(paste(year, month, "1", sep = "-"), format = "%Y-%m-%d")) %>% 
  mutate(flow = case_when(flow == "Total Exports" ~ "Exports",
                          flow == "Total Imports" ~ "Imports")) %>% 
  filter(divcode != 22)


ffdcountry <- read.csv(here("data", "raw", "ffdcountry202103.csv"),
                       col.names = c("year", "month", "flow", "eunoneu", "country", "divcode", "divdesc", "value", "tonnes")) %>% 
    mutate(date = as.Date(paste(year, month, "1", sep = "-"), format = "%Y-%m-%d"), 
           flow = case_when(flow == "Total Exports" ~ "Exports",
                          flow == "Total Imports" ~ "Imports"))

nonresponse <- read_csv(here("data", "raw", "nonresponse202103.csv"),
                        col_names = c("sitc1",
                                      "sitc2",
                                      "sitc3",
                                      "sitc4",
                                      "sitc5",
                                      "flow",
                                      "year",
                                      "month",
                                      "include",
                                      "value_sterling"),
                        skip = 1) %>% 
  select(!(sitc3:sitc5)) %>% 
  mutate(date = ymd(paste(year, month, "1", sep = "-")),
         flow = case_when(flow == "EU - Exports" ~ "Exports",
                          flow == "EU - Imports" ~ "Imports"),
         divcode = case_when(str_starts(sitc2, "00") ~ 0,
                             str_starts(sitc2, "01") ~ 1,
                             str_starts(sitc2, "02") ~ 2,
                             str_starts(sitc2, "03") ~ 3,
                             str_starts(sitc2, "04") ~ 4,
                             str_starts(sitc2, "05") ~ 5,
                             str_starts(sitc2, "06") ~ 6,
                             str_starts(sitc2, "07") ~ 7,
                             str_starts(sitc2, "08") ~ 8,
                             str_starts(sitc2, "09") ~ 9,
                             str_starts(sitc2, "11") ~ 11,
                             str_starts(sitc2, "22") ~ 22,
                             str_starts(sitc2, "41") ~ 41,
                             str_starts(sitc2, "42") ~ 42,
                             str_starts(sitc2, "43") ~ 43),
         valuenr = value_sterling /1000) %>% 
         select(date, flow, divcode, valuenr) %>% 
         filter(divcode != 0)

divcodes <- read.csv(here("data", "tidy", "divcodes.csv"))


```

``` {r value_summary}

# FFD totals -----------------------------------------------------------------
# FFD by div
divs <- ffd %>% 
  group_by(flow, divcode, date) %>% 
  summarise(value = sum(value)) %>% 
  filter(date >= "2018-01-01") %>% 
  ungroup()

# Join with nonresponse
ffdall <- divs %>% 
     left_join(nonresponse) %>% 
      mutate(valuetot = replace_na(value + valuenr, 0)) %>% 
      group_by(date, flow) %>% 
      summarise(value = sum(valuetot)) %>% 
      ungroup()

# Get year on year %ages
yoy <- ffdall %>%
      group_by(flow) %>%
      mutate(diff = lag(value, n = 12, order_by = date),
             yoy = (value/diff)-1) %>%
      arrange(flow)

# EU split --------------------------------------------------------------------
eu <- ffdcountry %>% 
        select(date, flow, eunoneu, country, divcode, divdesc, value) %>% 
        group_by(date, flow, eunoneu) %>% 
        summarise(value = sum(value))

euyoy <- eu %>% 
        group_by(eunoneu, flow) %>% 
        mutate(diff = lag(value, n = 12),
               yoy = percent((value/diff) - 1),
               amount = money(value*1000)) %>% 
        arrange(flow, eunoneu) %>% 
        filter(date == "2021-03-01") %>% 
        select(flow, eunoneu, amount, yoy)



```

## Trade in FFD by value

-   __Imports__ in March were **`r yoy %>% filter(date == "2021-03-01", flow == "Imports") %>% mutate(value = value * 1000) %>%  pull(value) %>% money`** which is `r  yoy %>% filter(date == "2021-03-01", flow == "Imports")  %>% pull(yoy) %>% scales::percent()` down on March 2020. Trade has generally recovered from the downturn seen in the first two months of 2021.

-   __Exports__ in March were **`r yoy %>% filter(date == "2021-03-01", flow == "Exports") %>% mutate(value = value * 1000) %>%  pull(value) %>% money`** which is `r  yoy %>% filter(date == "2021-03-01", flow == "Exports")  %>% pull(yoy) %>% scales::percent()` down on March 2020.

Trade has generally recovered from the downturn seen in the first two months of 2021.

`r knitr::kable(euyoy)`


```{r }

ffdall %>%
  ggplot(aes(x = date, y = value)) + 
  geom_line(aes(colour = flow), stat = "identity") +
  facet_grid(rows = ~flow) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  labs(x = NULL,
       y = "£000s",
       title = "Value of trade in food, feed and drink")



yoy %>% 
  ggplot(aes(x = date, y = yoy)) +
  geom_bar(aes(fill = flow), stat = "identity") +
  facet_grid(rows = ~flow) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_date(limits = ymd(c("2018-01-01", "2021-03-01"))) +
  theme_minimal() +
  labs(x = NULL,
       y = "% change year on year",
       title = "Percentage change in value of trade")

eu %>% 
  ggplot(aes(x = date, y = value)) +
  geom_line(aes(colour = flow)) +
  facet_grid(rows = ~eunoneu) +
  theme_minimal() +
  scale_y_continuous(labels = comma) +
  labs(x = NULL,
       y = "£000s",
       title = "Value of trade")

```



``` {r product}

ffddiv <- divs %>% 
     left_join(nonresponse) %>% 
     left_join(divcodes) %>% 
      mutate(valuetot = replace_na(value + valuenr, 0)) %>% 
      select(!c(value, valuenr, divcode)) %>%  
      group_by(flow, divdesc, date) %>% 
      summarise(valuetot = sum(valuetot))

divyoy <- ffddiv %>%
  group_by(flow, divdesc) %>% 
      mutate(diff = lag(valuetot, n = 12),
               yoy = percent((valuetot/diff) - 1),
               amount = money(valuetot*1000)) %>% 
  filter(date == "2021-03-01") %>% 
  select(flow, divdesc, amount, yoy)

ffddiv %>% 
  ggplot(aes(x = date, y = valuetot)) +
  geom_line(aes(colour = flow)) +
  facet_wrap(~divdesc) +
  theme_minimal()

```

## By product

`r knitr::kable(divyoy)`



## Country splits 

``` {r countries}

euirl <- ffdcountry %>% 
  mutate(euirl = (case_when(eunoneu == "EU" & country == "Irish Republic" ~ "Ireland",
                            eunoneu == "EU" & country != "Irish Republic" ~ "EU exc RoI",
                            eunoneu == "Non EU" ~ "RoW"))) %>% 
        select(date, flow, euirl, country, divdesc, value) %>% 
        group_by(date, flow, euirl, divdesc) %>% 
        summarise(value = sum(value))

euirl %>% 
  filter(flow == "Imports") %>% 
  ggplot(aes(x = date, y = value)) +
  geom_line(aes(colour = euirl)) + 
  facet_wrap(~divdesc) +
  theme_minimal()


```












## Annex - Non response estimates

Non response does not impact very much on overall trade values.

``` {r nonresponse}

nrdiv <- divs %>% 
     left_join(nonresponse) %>% 
      # mutate(valuetot = replace_na(value + valuenr, 0)) %>% 
      pivot_longer(cols = value:valuenr)

nrdiv %>% 
  # filter(flow == "Exports") %>% 
  ggplot(aes(x = date, y = value)) + 
  geom_bar(aes(fill = name), stat = "identity") +
  facet_grid(row = ~flow) +
  theme_minimal()

```